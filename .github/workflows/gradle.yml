# WARNING: Do not edit this file directly. Instead, go to:
#
# https://github.com/micronaut-projects/micronaut-project-template/tree/master/.github/workflows
#
# and edit them there. Note that it will be sync'ed to all the Micronaut repos
name: Java CI
on:
  push:
    branches:
      - master
      - '[0-9]+.[0-9]+.x'
  pull_request:
    branches:
      - master
      - '[0-9]+.[0-9]+.x'
jobs:
  build:
    if: github.repository != 'micronaut-projects/micronaut-project-template'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: ['21', '25']
    env:
      DEVELOCITY_ACCESS_KEY: ${{ secrets.GRADLE_ENTERPRISE_ACCESS_KEY }}
      DEVELOCITY_CACHE_USERNAME: ${{ secrets.GRADLE_ENTERPRISE_CACHE_USERNAME }}
      DEVELOCITY_CACHE_PASSWORD: ${{ secrets.GRADLE_ENTERPRISE_CACHE_PASSWORD }}
      GH_TOKEN_PUBLIC_REPOS_READONLY: ${{ secrets.GH_TOKEN_PUBLIC_REPOS_READONLY }}
      GH_USERNAME: ${{ secrets.GH_USERNAME }}
      TESTCONTAINERS_RYUK_DISABLED: true
      PREDICTIVE_TEST_SELECTION: "${{ github.event_name == 'pull_request' && 'true' || 'false' }}"
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OSS_INDEX_USERNAME: ${{ secrets.OSS_INDEX_USERNAME }}
      OSS_INDEX_PASSWORD: ${{ secrets.OSS_INDEX_PASSWORD }}
    steps:
       # https://github.com/actions/virtual-environments/issues/709
      - name: Remove system JDKs
        run: |
          sudo rm -rf /usr/lib/jvm/*
          unset JAVA_HOME
          export PATH=$(echo "$PATH" | tr ':' '\n' | grep -v '/usr/lib/jvm' | paste -sd:)
      - name: "üóë Free disk space"
        run: |
         sudo rm -rf "/usr/local/share/boost"
         sudo rm -rf "$AGENT_TOOLSDIRECTORY"
         sudo apt-get clean
         df -h

      - name: "üì• Checkout repository"
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: "üîß Setup GraalVM CE"
        uses: graalvm/setup-graalvm@v1.4.2
        with:
          distribution: 'graalvm'
          java-version: ${{ matrix.java }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: "üîß Setup Gradle"
        uses: gradle/actions/setup-gradle@v5

      - name: "‚ùì Optional setup step"
        run: |
          [ -f ./setup.sh ] && ./setup.sh || [ ! -f ./setup.sh ]

      - name: "üöî Sonatype Scan"
        if: env.OSS_INDEX_PASSWORD != '' && matrix.java == '21'
        id: sonatypescan
        run: |
          ./gradlew ossIndexAudit --no-parallel --info

      - name: "üõ† Build with Gradle"
        id: gradle
        run: |
          ./gradlew check jacocoReport --no-daemon --continue

      - name: "üîé Run static analysis"
        if: env.SONAR_TOKEN != '' && matrix.java == '21'
        run: |
          ./gradlew sonar --no-parallel --continue

      - name: "üìä Publish Test Report"
        if: always()
        uses: mikepenz/action-junit-report@v6
        with:
          check_name: Java CI / Test Report (${{ matrix.java }})
          report_paths: '**/build/test-results/test/TEST-*.xml'
          check_retries: 'true'

      - name: "üìú Upload binary compatibility check results"
        if: matrix.java == '21'
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: binary-compatibility-reports
          path: "**/build/reports/binary-compatibility-*.html"

      - name: "üì¶ Publish to Sonatype Snapshots"
        if: success() && github.event_name == 'push' && matrix.java == '21'
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
        run: ./gradlew publishToSonatype docs --no-daemon

      - name: "‚ùì Determine docs target repository"
        uses: haya14busa/action-cond@v1
        id: docs_target
        with:
          cond: ${{ github.repository == 'micronaut-projects/micronaut-core' }}
          if_true: "micronaut-projects/micronaut-docs"
          if_false: ${{ github.repository }}

      - name: "üìë Publish to Github Pages"
        if: success() && github.event_name == 'push' && matrix.java == '21'
        uses: micronaut-projects/github-pages-deploy-action@master
        env:
          TARGET_REPOSITORY: ${{ steps.docs_target.outputs.value }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          BRANCH: gh-pages
          FOLDER: build/docs

      - name: "‚ùì Optional cleanup step"
        run: |
          [ -f ./cleanup.sh ] && ./cleanup.sh || [ ! -f ./cleanup.sh ]
